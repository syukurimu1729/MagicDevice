<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔法の端末</title>
    <style>
        body { background: #1a1a2e; color: white; text-align: center; font-family: sans-serif; margin: 0; padding: 20px; }
        .panel { border: 2px solid #e94560; border-radius: 15px; padding: 15px; margin-bottom: 20px; background: rgba(22, 33, 62, 0.8); }
        #display-img { max-width: 100%; height: auto; border-radius: 10px; margin: 15px 0; border: 1px solid #444; }
        select, button { background: #0f3460; color: white; border: 1px solid #e94560; padding: 10px 20px; border-radius: 5px; font-size: 1em; }
        .btn-scan { background: #e94560; text-decoration: none; display: inline-block; margin-top: 20px; padding: 10px 20px; border-radius: 5px; color: white; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>魔法の端末</h1>

    <div class="panel">
        <h2 id="media-title">媒体未接続</h2>
        <img id="display-img" src="" class="hidden">
        <p id="result-text">QRコードをスキャンして媒体に接続してください。</p>
    </div>

    <div id="action-ui" class="panel hidden">
        <select id="magic-select"></select>
        <button onclick="castMagic()">魔法発動</button>
    </div>

    <a href="scan.html" class="btn-scan">スキャンモード起動</a>

    <script>
        let gameData = null;

        async function init() {
            // 1. JSONデータの読み込み
            const res = await fetch('magics.json');
            gameData = await res.json();

            // 2. 魔法セレクトボックスの生成
            const select = document.getElementById('magic-select');
            gameData.magics.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.innerText = m.name;
                select.appendChild(opt);
            });

            updateUI();
        }

        function updateUI() {
            const mediaId = localStorage.getItem('currentMedia');
            const mediaTitle = document.getElementById('media-title');
            const displayImg = document.getElementById('display-img');
            const actionUi = document.getElementById('action-ui');

            if (mediaId && gameData.media_data[mediaId]) {
                const data = gameData.media_data[mediaId];
                mediaTitle.innerText = "接続中: " + mediaId;
                displayImg.src = "assets/media/" + data.default_img;
                displayImg.classList.remove('hidden');
                actionUi.classList.remove('hidden');
            }
        }

        function castMagic() {
            const mediaId = localStorage.getItem('currentMedia');
            const magicId = document.getElementById('magic-select').value;
            const effect = gameData.media_data[mediaId].effects[magicId];
            
            const resultText = document.getElementById('result-text');
            const displayImg = document.getElementById('display-img');

            if (effect) {
                resultText.innerText = effect.res;
                displayImg.src = "assets/media/" + effect.img; // 結果画像に差し替え
            } else {
                resultText.innerText = "何も起きなかった...";
                // デフォルト画像に戻す
                displayImg.src = "assets/media/" + gameData.media_data[mediaId].default_img;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
