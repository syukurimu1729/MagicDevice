<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0,
               user-scalable=no, viewport-fit=cover">
<title>魔法スキャナー</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root {
    --accent-red: #ff2d55;
    --glow-red: 0 0 15px rgba(255,45,85,.6);
    --bg-dark: #0d0d1a;
    --controls-h: 190px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    background:#000;
    color:#e0e0ff;
    font-family:'Segoe UI', sans-serif;
    width:100%;
    height:100dvh;
    overflow:hidden;
}

/* ===============================
   CAMERA AREA
================================ */
#camera-area {
    position: relative;
    width:100%;
    height: calc(100dvh - var(--controls-h));
    background:#000;
    overflow:hidden;
}

#reader {
    width:100%;
    height:100%;
}

#reader video {
    width:100%;
    height:100%;
    object-fit:cover;
}

/* overlays */
.overlay {
    position:absolute;
    inset:0;
    pointer-events:none;
}

.hud-corner {
    position:absolute;
    width:30px;
    height:30px;
    border:2px solid var(--accent-red);
    filter:drop-shadow(var(--glow-red));
}

.top-left { top:16px; left:16px; border-right:none; border-bottom:none; }
.top-right { top:16px; right:16px; border-left:none; border-bottom:none; }
.bottom-left { bottom:16px; left:16px; border-right:none; border-top:none; }
.bottom-right { bottom:16px; right:16px; border-left:none; border-top:none; }

#qr-shutter {
    display:none;
    position:absolute;
    inset:0;
    margin:auto;
    width:220px;
    height:220px;
    border:1px solid rgba(255,45,85,.5);
    background:rgba(255,45,85,.05);
    box-shadow: inset 0 0 20px rgba(255,45,85,.2);
}

#barcode-line {
    display:none;
    position:absolute;
    left:10%;
    width:80%;
    height:2px;
    background:var(--accent-red);
    box-shadow:var(--glow-red);
    animation:scan 2s infinite ease-in-out;
}

@keyframes scan {
    0%,100% { top:45%; opacity:.3; }
    50% { top:55%; opacity:1; }
}

#flash {
    position:absolute;
    inset:0;
    background:transparent;
}

@keyframes flash {
    0%{background:transparent}
    50%{background:rgba(0,255,204,.2)}
    100%{background:transparent}
}

/* ===============================
   CONTROLS
================================ */
.controls {
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    height:var(--controls-h);
    padding:16px 0 calc(16px + env(safe-area-inset-bottom));
    background:var(--bg-dark);
    border-top:1px solid var(--accent-red);
    box-shadow:0 -10px 20px rgba(0,0,0,.6);
    display:flex;
    flex-direction:column;
    align-items:center;
    z-index:100;
}

#status-msg {
    font-size:.7rem;
    margin-bottom:8px;
    color:#888;
}

#scan-trigger {
    width:85%;
    max-width:360px;
    padding:14px;
    border:none;
    border-radius:12px;
    font-weight:bold;
    color:#fff;
    background:linear-gradient(135deg,var(--accent-red),#ff5e7e);
    box-shadow:var(--glow-red);
}

.btn-group {
    display:flex;
    gap:10px;
    margin-top:10px;
}

.mode-btn {
    padding:6px 14px;
    border-radius:20px;
    border:1px solid #333;
    background:rgba(255,255,255,.05);
    color:#888;
    font-size:.7rem;
}

.mode-btn.active {
    color:#fff;
    border-color:var(--accent-red);
    box-shadow:var(--glow-red);
}

/* safari fallback */
@supports (-webkit-touch-callout: none) {
    body { height:-webkit-fill-available; }
}
</style>
</head>

<body>

<!-- CAMERA -->
<div id="camera-area">
    <div id="reader"></div>

    <div class="overlay">
        <div class="hud-corner top-left"></div>
        <div class="hud-corner top-right"></div>
        <div class="hud-corner bottom-left"></div>
        <div class="hud-corner bottom-right"></div>

        <div id="qr-shutter"></div>
        <div id="barcode-line"></div>
        <div id="flash"></div>
    </div>
</div>

<!-- CONTROLS -->
<div class="controls">
    <div id="status-msg">SYSTEM READY</div>
    <button id="scan-trigger">解析を確定する</button>
    <div class="btn-group">
        <button id="btn-barcode" class="mode-btn active">魔法習得</button>
        <button id="btn-qr" class="mode-btn">媒体接続</button>
    </div>
</div>

<script>
let html5QrCode;
let lastResult = null;
let currentMode = "barcode";

window.addEventListener("load", () => {
    startScanner("barcode");
});

function startScanner(mode) {
    currentMode = mode;
    lastResult = null;

    document.getElementById("btn-barcode").classList.toggle("active", mode==="barcode");
    document.getElementById("btn-qr").classList.toggle("active", mode==="qr");
    document.getElementById("barcode-line").style.display = mode==="barcode" ? "block" : "none";
    document.getElementById("qr-shutter").style.display = mode==="qr" ? "block" : "none";

    const status = document.getElementById("status-msg");
    status.innerText = "カメラ起動中…";

    if (html5QrCode) {
        html5QrCode.stop().catch(()=>{});
    }

    html5QrCode = new Html5Qrcode("reader");

    const formats = mode==="qr"
        ? [Html5QrcodeSupportedFormats.QR_CODE]
        : [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E
        ];

    html5QrCode.start(
        { facingMode: "environment" },
        { fps:20, formatsToSupport:formats },
        (text) => {
            if (lastResult !== text) {
                lastResult = text;
                status.innerText = "解析準備完了";
                status.style.color = "#00ffcc";
                console.log("scanned:", text);
            }
        }
    ).catch(err => {
        status.innerText = "カメラを起動できません";
        console.error(err);
    });
}

document.getElementById("btn-barcode").onclick = () => startScanner("barcode");
document.getElementById("btn-qr").onclick = () => startScanner("qr");

document.getElementById("scan-trigger").onclick = () => {
    if (!lastResult) return;
    const flash = document.getElementById("flash");
    flash.style.animation = "none";
    void flash.offsetWidth;
    flash.style.animation = "flash .4s";
};
</script>

</body>
</html>
