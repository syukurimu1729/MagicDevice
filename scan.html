<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>È≠îÊ≥ï„Çπ„Ç≠„É£„Éä„Éº</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root {
    --accent-red: #ff2d55;
    --glow-red: 0 0 15px rgba(255, 45, 85, 0.6);
    --bg-dark: #0d0d1a;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

@keyframes pageIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes successFlash { 0% { background: transparent; } 50% { background: rgba(0,255,204,0.2); } 100% { background: transparent; } }
@keyframes modalUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

body {
    background:#000; color:#e0e0ff; font-family:'Segoe UI',sans-serif;
    height:100vh; display:flex; flex-direction:column; align-items:center;
    overflow:hidden; animation:pageIn 0.5s ease-out;
}

#reader-wrapper {
    position:relative; flex:1; width:100%;
    display:flex; justify-content:center; align-items:center; overflow:hidden;
}

#reader { width:100%!important; max-width:500px; }
#reader video { width:100%!important; height:100%!important; object-fit:cover!important; }

#flash-layer { position:absolute; inset:0; pointer-events:none; z-index:150; }

.hud-corner {
    position:absolute; width:30px; height:30px;
    border:2px solid var(--accent-red); z-index:105;
    filter:drop-shadow(var(--glow-red));
}
.top-left{top:20px;left:20px;border-right:none;border-bottom:none;}
.top-right{top:20px;right:20px;border-left:none;border-bottom:none;}
.bottom-left{bottom:20px;left:20px;border-right:none;border-top:none;}
.bottom-right{bottom:20px;right:20px;border-left:none;border-top:none;}

#qr-shutter {
    display:none; position:absolute; top:50%; left:50%;
    width:220px; height:220px;
    border:1px solid rgba(255,45,85,.5);
    background:rgba(255,45,85,.05);
    transform:translate(-50%,-50%);
    box-shadow:inset 0 0 20px rgba(255,45,85,.2);
}

#barcode-line {
    display:none; position:absolute; top:50%; left:10%;
    width:80%; height:2px; background:var(--accent-red);
    box-shadow:var(--glow-red);
    animation:scan-move 2s infinite ease-in-out;
}

@keyframes scan-move {
    0%,100%{transform:translateY(-40px);opacity:.3;}
    50%{transform:translateY(40px);opacity:1;}
}

.controls {
    width:100%; padding:20px;
    background:var(--bg-dark);
    border-top:1px solid var(--accent-red);
    display:flex; flex-direction:column; align-items:center;
}

#status-msg { font-size:.75rem; margin-bottom:8px; color:#888; letter-spacing:.1rem; }

#scan-trigger {
    width:85%; max-width:400px; padding:16px;
    border:none; border-radius:12px;
    background:linear-gradient(135deg,var(--accent-red),#ff5e7e);
    color:#fff; font-weight:bold;
    box-shadow:var(--glow-red);
}

.btn-group { display:flex; gap:10px; margin:15px 0; }
.mode-btn {
    padding:8px 16px; border-radius:20px;
    background:rgba(255,255,255,.05);
    color:#888; border:1px solid #333;
}
.mode-btn.active {
    color:#fff; border-color:var(--accent-red);
    background:rgba(255,45,85,.2);
    box-shadow:var(--glow-red);
}

.back-link { color:#555; text-decoration:none; font-size:.8rem; }

#result-modal {
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,.9);
    justify-content:center; align-items:center;
}

.modal-content {
    background:#101025; border:1px solid var(--accent-red);
    border-radius:24px; padding:25px; width:85%; max-width:320px;
    box-shadow:var(--glow-red); text-align:center;
    animation:modalUp .4s cubic-bezier(.18,.89,.32,1.28);
}

#reader__dashboard{display:none!important;}
</style>
</head>

<body>

<div id="reader-wrapper">
    <div id="flash-layer"></div>
    <div class="hud-corner top-left"></div>
    <div class="hud-corner top-right"></div>
    <div class="hud-corner bottom-left"></div>
    <div class="hud-corner bottom-right"></div>
    <div id="reader"></div>
    <div id="qr-shutter"></div>
    <div id="barcode-line"></div>
</div>

<div class="controls">
    <div id="status-msg">SYSTEM READY</div>
    <button id="scan-trigger" onclick="pressScan()">Ëß£Êûê„ÇíÁ¢∫ÂÆö„Åô„Çã</button>

    <div class="btn-group">
        <button id="btn-barcode" class="mode-btn" onclick="startScanner('barcode')">È≠îÊ≥ïÁøíÂæó</button>
        <button id="btn-qr" class="mode-btn" onclick="startScanner('qr')">Â™í‰ΩìÊé•Á∂ö</button>
        <button class="mode-btn" onclick="switchCamera()">üì∑ÂàáÊõø</button>
    </div>

    <a href="index.html" class="back-link">CANCEL</a>
</div>

<div id="result-modal">
    <div class="modal-content">
        <div id="modal-title">DATA ACQUIRED</div>
        <div id="modal-name" class="modal-name">È≠îÊ≥ïÂêç</div>
        <div id="modal-desc"></div>
        <button onclick="closeModal()">Èñâ„Åò„Çã</button>
    </div>
</div>

<script>
let html5QrCode;
let cameras = [];
let cameraIndex = 0;
let lastResult = null;
let currentMode = 'barcode';
let gameData = null;

async function loadData() {
    const res = await fetch('magics.json');
    gameData = await res.json();
    cameras = await Html5Qrcode.getCameras();

    // ËÉåÈù¢„Å£„ÅΩ„ÅÑ„Ç´„É°„É©„ÇíÂàùÊúüÈÅ∏Êäû
    const back = cameras.findIndex(c => /back|rear|environment/i.test(c.label));
    cameraIndex = back >= 0 ? back : 0;

    startScanner('barcode');
}

async function startScanner(mode) {
    currentMode = mode;
    lastResult = null;

    if (html5QrCode) await html5QrCode.stop().catch(()=>{});

    document.getElementById('btn-barcode').classList.toggle('active', mode==='barcode');
    document.getElementById('btn-qr').classList.toggle('active', mode==='qr');

    document.getElementById('qr-shutter').style.display = mode==='qr'?'block':'none';
    document.getElementById('barcode-line').style.display = mode==='barcode'?'block':'none';

    html5QrCode = new Html5Qrcode("reader");

    const formats = mode==='qr'
        ? [Html5QrcodeSupportedFormats.QR_CODE]
        : [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E
        ];

    html5QrCode.start(
        cameras[cameraIndex].id,
        { fps:10, formatsToSupport:formats },
        text => {
            if (text !== lastResult) {
                lastResult = text;
                document.getElementById('status-msg').innerText = "Ëß£ÊûêÊ∫ñÂÇôÂÆå‰∫Ü";
            }
        }
    );
}

function switchCamera() {
    cameraIndex = (cameraIndex + 1) % cameras.length;
    startScanner(currentMode);
}

function pressScan() {
    if (!lastResult) return;
    handleSuccess(currentMode, lastResult);
}

function handleSuccess(mode, text) {
    const clean = text.replace(/\*/g,'');
    if (mode==='barcode') {
        const magic = gameData.magics.find(m=>m.code===clean);
        if (magic) showModal("NEW SKILL", magic.name, magic.desc);
    }
}

function showModal(t,n,d){
    document.getElementById('modal-title').innerText=t;
    document.getElementById('modal-name').innerText=n;
    document.getElementById('modal-desc').innerText=d;
    document.getElementById('result-modal').style.display='flex';
}

function closeModal(){ location.href="index.html"; }

window.onload = loadData;
</script>
</body>
</html>
