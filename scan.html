<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スキャンモード</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #000; color: white; text-align: center; font-family: sans-serif; margin: 0; }
        #reader { width: 100%; max-width: 500px; margin: auto; }
        .scan-ui { position: fixed; bottom: 50px; width: 100%; z-index: 100; }
        .btn-back { color: #aaa; text-decoration: none; display: block; margin-top: 20px; }
        /* バーコード用の赤い線 */
        .barcode-line { position: absolute; top: 50%; left: 10%; width: 80%; height: 2px; background: red; box-shadow: 0 0 8px red; z-index: 10; display: none; }
        .btn-toggle { background: #333; color: white; border: 1px solid #777; padding: 10px; margin: 5px; border-radius: 5px; }
        .active { border-color: red; background: #500; }
    </style>
</head>
<body>
    <div style="padding: 10px;">
        <button id="mode-barcode" class="btn-toggle active" onclick="switchMode('barcode')">魔法コード(棒)</button>
        <button id="mode-qr" class="btn-toggle" onclick="switchMode('qr')">媒体読み込み(枠)</button>
    </div>

    <div id="reader-container" style="position: relative;">
        <div id="reader"></div>
        <div id="scan-line" class="barcode-line"></div>
    </div>

    <div class="scan-ui">
        <div id="status">カメラ起動中...</div>
        <a href="index.html" class="btn-back">← 端末に戻る</a>
    </div>

    <script>
        let html5QrCode;
        let currentMode = 'barcode';

        async function startScanner(mode) {
            if (html5QrCode) await html5QrCode.stop();
            currentMode = mode;
            
            document.getElementById('mode-barcode').classList.toggle('active', mode === 'barcode');
            document.getElementById('mode-qr').classList.toggle('active', mode === 'qr');
            document.getElementById('scan-line').style.display = (mode === 'barcode') ? 'block' : 'none';

            html5QrCode = new Html5Qrcode("reader");
            const config = { 
                fps: 10, 
                qrbox: mode === 'barcode' ? { width: 300, height: 120 } : { width: 250, height: 250 } 
            };

            html5QrCode.start({ facingMode: "environment" }, config, (text) => {
                // 読み取り成功時の処理
                if (currentMode === 'barcode') {
                    // 魔法習得（例）
                    let magics = JSON.parse(localStorage.getItem('myMagics')) || [];
                    if(!magics.includes(text)) magics.push(text);
                    localStorage.setItem('myMagics', JSON.stringify(magics));
                    alert("魔法コード「" + text + "」を読み込みました！");
                } else {
                    // 媒体接続（例）
                    localStorage.setItem('currentMedia', "接続中の媒体: " + text);
                    alert("媒体「" + text + "」に接続しました！");
                }
                location.href = "index.html"; // トップに戻る
            });
        }

        window.onload = () => startScanner('barcode');
        function switchMode(m) { startScanner(m); }
    </script>
</body>
</html>
