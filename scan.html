<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0,
               user-scalable=no, viewport-fit=cover">
<title>魔法スキャナー</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root {
    --accent-red:#ff2d55;
    --glow-red:0 0 15px rgba(255,45,85,.6);
    --controls-h:190px;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
    background:#000;
    color:#e0e0ff;
    font-family:sans-serif;
    height:100dvh;
    overflow:hidden;
}

/* camera */
#camera-area{
    height:calc(100dvh - var(--controls-h));
    width:100%;
    position:relative;
    overflow:hidden;
}

#reader, #reader video{
    width:100%;
    height:100%;
    object-fit:cover;
}

.overlay{position:absolute;inset:0;pointer-events:none}

.hud{
    position:absolute;
    width:30px;height:30px;
    border:2px solid var(--accent-red);
    filter:drop-shadow(var(--glow-red));
}
.tl{top:16px;left:16px;border-right:none;border-bottom:none}
.tr{top:16px;right:16px;border-left:none;border-bottom:none}
.bl{bottom:16px;left:16px;border-right:none;border-top:none}
.br{bottom:16px;right:16px;border-left:none;border-top:none}

#barcode-line{
    display:none;
    position:absolute;
    left:10%;
    width:80%;
    height:2px;
    background:var(--accent-red);
    box-shadow:var(--glow-red);
    animation:scan 2s infinite;
}

@keyframes scan{
    0%,100%{top:45%;opacity:.3}
    50%{top:55%;opacity:1}
}

/* controls */
.controls{
    position:fixed;
    bottom:0;
    width:100%;
    height:var(--controls-h);
    padding:16px 0 calc(16px + env(safe-area-inset-bottom));
    background:#0d0d1a;
    border-top:1px solid var(--accent-red);
    display:flex;
    flex-direction:column;
    align-items:center;
}

#status-msg{
    font-size:.75rem;
    color:#888;
    margin-bottom:8px;
}

#scan-trigger{
    width:85%;
    max-width:360px;
    padding:14px;
    border:none;
    border-radius:12px;
    font-weight:bold;
    color:white;
    background:linear-gradient(135deg,#ff2d55,#ff5e7e);
    box-shadow:var(--glow-red);
}

.btn-group{
    display:flex;
    gap:10px;
    margin-top:10px;
}

.mode-btn{
    padding:6px 14px;
    border-radius:20px;
    border:1px solid #333;
    background:rgba(255,255,255,.05);
    color:#888;
    font-size:.7rem;
}
.mode-btn.active{
    color:#fff;
    border-color:var(--accent-red);
    box-shadow:var(--glow-red);
}
</style>
</head>

<body>

<div id="camera-area">
    <div id="reader"></div>
    <div class="overlay">
        <div class="hud tl"></div>
        <div class="hud tr"></div>
        <div class="hud bl"></div>
        <div class="hud br"></div>
        <div id="barcode-line"></div>
    </div>
</div>

<div class="controls">
    <div id="status-msg">SYSTEM READY</div>
    <button id="scan-trigger">解析を確定する</button>
    <div class="btn-group">
        <button id="btn-barcode" class="mode-btn active">魔法習得</button>
        <button id="btn-qr" class="mode-btn">媒体接続</button>
    </div>
</div>

<script>
let html5QrCode;
let lastResult=null;
let mode="barcode";

window.onload=()=>startScanner("barcode");

function startScanner(m){
    mode=m;
    lastResult=null;

    document.getElementById("btn-barcode").classList.toggle("active",m==="barcode");
    document.getElementById("btn-qr").classList.toggle("active",m==="qr");
    document.getElementById("barcode-line").style.display=m==="barcode"?"block":"none";

    const status=document.getElementById("status-msg");
    status.innerText="カメラ起動中…";
    status.style.color="#888";

    if(html5QrCode){
        html5QrCode.stop().catch(()=>{});
    }

    html5QrCode=new Html5Qrcode("reader");

    html5QrCode.start(
        {
            facingMode:"environment",
            width:{ ideal:1280 },
            height:{ ideal:720 }
        },
        {
            fps:10,   // ← iOSで安定
            disableFlip:true
        },
        (text)=>{
            if(text!==lastResult){
                lastResult=text;
                status.innerText="解析準備完了";
                status.style.color="#00ffcc";
                console.log("DETECTED:",text);
            }
        },
        ()=>{}
    ).catch(err=>{
        status.innerText="カメラ起動失敗";
        console.error(err);
    });
}

document.getElementById("btn-barcode").onclick=()=>startScanner("barcode");
document.getElementById("btn-qr").onclick=()=>startScanner("qr");

document.getElementById("scan-trigger").onclick=()=>{
    if(!lastResult) return;
    alert("解析成功:\n"+lastResult);
};
</script>

</body>
</html>
