<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>魔法スキャナー</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
/* ===== CSSは元コードそのまま ===== */
:root {
    --accent-red: #ff2d55;
    --glow-red: 0 0 15px rgba(255, 45, 85, 0.6);
    --bg-dark: #0d0d1a;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
/* （中略：CSSは一切変更していません） */
#reader__dashboard { display: none !important; }
</style>
</head>

<body>
<!-- ===== HTML構造も元コードそのまま ===== -->
<div id="reader-wrapper">
    <div id="flash-layer"></div>
    <div class="hud-corner top-left"></div>
    <div class="hud-corner top-right"></div>
    <div class="hud-corner bottom-left"></div>
    <div class="hud-corner bottom-right"></div>
    <div id="reader"></div>
    <div id="qr-shutter"></div>
    <div id="barcode-line"></div>
</div>

<div class="controls">
    <div id="status-msg">SYSTEM READY</div>
    <button id="scan-trigger" onclick="pressScan()">解析を確定する</button>
    <div class="btn-group">
        <button id="btn-barcode" class="mode-btn" onclick="startScanner('barcode')">魔法習得</button>
        <button id="btn-qr" class="mode-btn" onclick="startScanner('qr')">媒体接続</button>
    </div>
    <a href="index.html" class="back-link">CANCEL</a>
</div>

<div id="result-modal">
    <div class="modal-content">
        <div id="modal-title">DATA ACQUIRED</div>
        <div id="modal-name" class="modal-name">魔法名</div>
        <div id="modal-desc">説明文</div>
        <button onclick="closeModal()">閉じる</button>
    </div>
</div>

<script>
let html5QrCode;
let lastResult = null;
let currentMode = 'barcode';
let gameData = null;
let isErrorState = false;

async function loadData() {
    const res = await fetch('magics.json');
    gameData = await res.json();
    startScanner('barcode');
}

async function startScanner(mode) {
    currentMode = mode;
    lastResult = null;
    isErrorState = false;

    const statusMsg = document.getElementById('status-msg');
    const qrShutter = document.getElementById('qr-shutter');
    const barcodeLine = document.getElementById('barcode-line');

    if (html5QrCode) {
        await html5QrCode.stop().catch(()=>{});
    }

    document.getElementById('btn-barcode').classList.toggle('active', mode === 'barcode');
    document.getElementById('btn-qr').classList.toggle('active', mode === 'qr');

    qrShutter.style.display = mode === 'qr' ? 'block' : 'none';
    barcodeLine.style.display = mode === 'barcode' ? 'block' : 'none';

    statusMsg.innerText = mode === 'qr' ? "QRコードを探索中..." : "バーコードを探索中...";

    const formats = (mode === 'qr')
        ? [Html5QrcodeSupportedFormats.QR_CODE]
        : [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E
        ];

    html5QrCode = new Html5Qrcode("reader");

    /* ===== ここが唯一の実質修正点 ===== */
    const cameras = await Html5Qrcode.getCameras();
    let backCam = cameras.find(c => /back|rear|environment/i.test(c.label));
    const cameraId = backCam ? backCam.id : cameras[cameras.length - 1].id;
    /* ================================= */

    html5QrCode.start(
        cameraId,
        {
            fps: 10,
            formatsToSupport: formats
        },
        (text) => {
            if (lastResult !== text) {
                lastResult = text;
                statusMsg.innerText = "解析準備完了";
                statusMsg.style.color = "#00ffcc";
            }
        }
    ).catch(err => {
        statusMsg.innerText = "カメラを起動できません";
        console.error(err);
    });
}

function pressScan() {
    if (!lastResult) return;
    handleSuccess(currentMode, lastResult);
}

function handleSuccess(mode, text) {
    const cleanText = text.replace(/\*/g, "");
    if (mode === 'barcode') {
        const magic = gameData.magics.find(m => m.code === cleanText);
        if (!magic) return;
        showModal("NEW SKILL", magic.name, magic.desc);
    }
}

function showModal(title, name, desc) {
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-name').innerText = name;
    document.getElementById('modal-desc').innerText = desc;
    document.getElementById('result-modal').style.display = 'flex';
}

function closeModal() {
    location.href = "index.html";
}

window.onload = loadData;
</script>
</body>
</html>
