<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>È≠îÊ≥ï„Çπ„Ç≠„É£„Éä„Éº</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
  --accent-red:#ff2d55;
  --ready-green:#00ffcc;
  --bg-dark:#0d0d1a;
  --panel-dark:#0f1120;
  --glow-red:0 0 18px rgba(255,45,85,0.5);
  --glow-green:0 0 18px rgba(0,255,204,0.45);
  --controls-h:180px;
}

/* reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:#000;
  color:#e6e9ff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  min-height:100svh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
}

/* camera area */
#reader-wrapper{
  position:relative;
  width:100%;
  height: calc(100dvh - var(--controls-h));
  max-height: calc(100dvh - var(--controls-h));
  overflow:hidden;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
}
#reader{ width:100%!important; height:100%!important; max-width:900px; }
#reader video{ width:100%!important; height:100%!important; object-fit:cover!important; display:block; }

/* flash / success overlay */
#flash-layer{ position:absolute; inset:0; pointer-events:none; z-index:150; }
#success-flash {
  position:absolute; inset:0; background: rgba(0,255,204,0.10);
  mix-blend-mode: screen; opacity:0; pointer-events:none; z-index:160;
  transition: opacity 180ms ease-out;
  box-shadow: inset 0 0 80px rgba(0,255,204,0.12);
}
#success-flash.show { opacity:1; transition: opacity 120ms ease-in; }

/* HUD corners */
.hud-corner {
  position:absolute; width:30px; height:30px;
  border:2px solid var(--accent-red); filter:drop-shadow(var(--glow-red));
  z-index:140;
  transition: opacity .18s ease, transform .18s ease;
  opacity:1;
}
body.modal-open .hud-corner { opacity:0; transform:scale(.98); }
.top-left{ top:16px; left:16px; border-right:none; border-bottom:none; }
.top-right{ top:16px; right:16px; border-left:none; border-bottom:none; }
.bottom-left{ bottom:16px; left:16px; border-right:none; border-top:none; }
.bottom-right{ bottom:16px; right:16px; border-left:none; border-top:none; }

/* qr shutter & barcode-line (JS toggles display) */
#qr-shutter{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:220px; height:220px; border-radius:12px; border:1px solid rgba(255,45,85,0.35); background:rgba(255,45,85,0.03); box-shadow: inset 0 0 20px rgba(255,45,85,0.06); z-index:130; display:none; }
#barcode-line{ position:absolute; left:10%; top:50%; width:80%; height:2px; background:var(--accent-red); box-shadow:var(--glow-red); z-index:130; display:none; animation: scan-move 2s infinite ease-in-out; }
@keyframes scan-move { 0%,100%{ transform:translateY(-40px); opacity:.25 } 50%{ transform:translateY(40px); opacity:1 } }

/* controls (bottom) */
.controls{
  width:100%;
  background:var(--panel-dark);
  border-top:1px solid rgba(255,45,85,0.06);
  padding:18px 16px calc(22px + env(safe-area-inset-bottom));
  display:flex; flex-direction:column; align-items:center; gap:12px;
  box-shadow: 0 -10px 30px rgba(0,0,0,0.6);
}
#status-msg{ font-size:.85rem; color:#9aa3b2; letter-spacing:.08em; transition: color .18s ease, text-shadow .18s ease; min-height:1.1em; text-align:center; }
#status-msg.ready{ color: var(--ready-green); text-shadow: var(--glow-green); }

/* transient message (error) styling: show as red background under status */
#transient-msg {
  margin-top:6px;
  font-size:.85rem;
  color:#ffdfe8;
  background: rgba(255,45,85,0.12);
  padding:8px 12px;
  border-radius:10px;
  display:none;
  max-width:88%;
  text-align:center;
}

/* scan trigger (main) */
#scan-trigger{
  width:100%; max-width:520px; height:56px; border-radius:14px; border:none;
  background: linear-gradient(135deg,var(--accent-red),#ff6a88);
  color:#fff; font-weight:800; font-size:1.05rem; box-shadow:var(--glow-red);
  -webkit-tap-highlight-color:transparent; cursor:pointer;
}

/* buttons group */
.btn-group{ display:flex; gap:10px; align-items:center; justify-content:center; }
.mode-btn{
  min-width:110px; height:44px; padding:0 16px; border-radius:999px;
  border:1px solid rgba(255,255,255,0.04);
  background: linear-gradient(180deg,#0c0c12,#0a0a12);
  color:#cdd6e6; font-weight:700; font-size:.95rem; box-shadow: 0 3px 8px rgba(0,0,0,0.5); cursor:pointer;
}
.mode-btn.active{ background: linear-gradient(135deg, rgba(255,45,85,0.2), rgba(255,45,85,0.08)); color:#fff; border-color: rgba(255,45,85,0.2); box-shadow:var(--glow-red); }
.mode-btn.switch{ min-width:48px; width:48px; padding:0; }

/* cancel */
.back-link{ color:#9aa3b2; text-decoration:none; font-size:.86rem; opacity:.95 }

/* modal redesign */
#result-modal{ display:none; position:fixed; inset:0; background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85)); z-index:999; justify-content:center; align-items:center; padding:22px; }
.modal-card{ width:100%; max-width:520px; background: linear-gradient(180deg,#0f1030,#0b0b18); border-radius:20px; border:1px solid rgba(255,45,85,0.12); padding:22px; box-shadow: 0 10px 40px rgba(0,0,0,0.7), var(--glow-red); color:#e9ecff; text-align:center; }
.modal-label{ font-size:.75rem; color:#9aa3b2; margin-bottom:8px; letter-spacing:.12em; }
.modal-name{ font-size: clamp(1.4rem, 4.8vw, 2.4rem); color:var(--accent-red); font-weight:900; margin:6px 0 10px; text-shadow: 0 0 10px rgba(255,45,85,0.18); }
.modal-desc{ font-size:1rem; color:#cfe7ff; line-height:1.45; margin-bottom:18px; min-height:3.2em; }

.modal-cta{ width:100%; height:56px; border-radius:12px; border:none; font-weight:800; font-size:1rem; color:#061018; background: linear-gradient(135deg,#00ffd0,#00c2a8); box-shadow:var(--glow-green); cursor:pointer; margin-top:6px; }
.modal-cancel{ margin-top:12px; display:inline-block; color:#b8c8da; text-decoration:underline; }

/* hide html5 dashboard if present */
#reader__dashboard{ display:none!important; }
</style>
</head>
<body>

<!-- camera area -->
<div id="reader-wrapper">
  <div id="flash-layer"></div>
  <div id="success-flash" aria-hidden="true"></div>

  <div class="hud-corner top-left"></div>
  <div class="hud-corner top-right"></div>
  <div class="hud-corner bottom-left"></div>
  <div class="hud-corner bottom-right"></div>

  <div id="reader"></div>

  <div id="qr-shutter"></div>
  <div id="barcode-line"></div>
</div>

<!-- controls -->
<div class="controls">
  <div id="status-msg">SYSTEM READY</div>

  <div id="transient-msg" role="status" aria-live="polite"></div>

  <button id="scan-trigger" onclick="pressScan()">Ëß£Êûê„ÇíÁ¢∫ÂÆö„Åô„Çã</button>

  <div class="btn-group">
    <button id="btn-barcode" class="mode-btn" onclick="startScanner('barcode')">È≠îÊ≥ïÁøíÂæó</button>
    <button id="btn-qr" class="mode-btn" onclick="startScanner('qr')">Â™í‰ΩìÊé•Á∂ö</button>
    <button class="mode-btn switch" onclick="switchCamera()">üì∑</button>
  </div>

  <a href="index.html" class="back-link">CANCEL</a>
</div>

<!-- modal -->
<div id="result-modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-label" id="modal-title">DATA ACQUIRED</div>
    <div id="modal-name" class="modal-name">È≠îÊ≥ïÂêç</div>
    <div id="modal-desc" class="modal-desc">Ë™¨ÊòéÊñá</div>

    <button class="modal-cta" id="modal-ok" onclick="closeModal()">Èñâ„Åò„Çã„Åó„Å¶ÂÖÉ„Å´Êàª„Çã</button>
    <div><a href="#" class="modal-cancel" onclick="closeModal(); return false;">„Ç≠„É£„É≥„Çª„É´</a></div>
  </div>
</div>

<script>
/*
  Â§âÊõ¥ÁÇπ„Åæ„Å®„ÇÅÔºàJSÔºâ
  - MEDIA:XXXX „ÅÆÊâ±„ÅÑ„ÅØÂÖÉ„Ç≥„Éº„Éâ„Å©„Åä„ÇäÔºà‰∏ã„Å´Ë™¨ÊòéÔºâ
  - Ë™§Ë™≠„ÅøÂèñ„Çä„Åß„ÄåÈ≠îÊ≥ï„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄçÊôÇ„ÅØ transient message „ÇíË°®Á§∫Ôºà3ÁßíÔºâ
  - Ëß£ÊûêÁ¢∫ÂÆöÊàêÂäüÊôÇ„Å´ success flash „Å®ÊåØÂãï„ÇíË°å„ÅÜ
  - scanArmed „Éï„É©„Ç∞„Åß„ÄåÊúÄÂàù„Å´„Åæ„Å®„ÇÇ„Å™Ë™≠„ÅøÂèñ„Çä„Äç„ÇíÊ§úÁü•„Åó„ÄÅ„É¶„Éº„Ç∂„Éº„ÅåÊäº„Åó„Åü„ÇâÁ¢∫ÂÆö„Åô„ÇãÊåôÂãï„ÅØÁ∂≠ÊåÅ
*/

let html5QrCode;
let cameras = [];
let cameraIndex = 0;
let lastResult = null;
let scanArmed = false;
let currentMode = 'barcode';
let gameData = null;
let transientTimer = null;

function showTransient(msg, duration = 3000) {
  const el = document.getElementById('transient-msg');
  clearTimeout(transientTimer);
  el.innerText = msg;
  el.style.display = 'block';
  transientTimer = setTimeout(() => {
    el.style.display = 'none';
    // restore default status text if appropriate
    const statusEl = document.getElementById('status-msg');
    if (!scanArmed) statusEl.innerText = "„Çπ„Ç≠„É£„É≥ÂæÖÊ©ü‰∏≠";
  }, duration);
}

// success visual + vibration (short)
function playSuccessEffect() {
  // green flash overlay
  const flash = document.getElementById('success-flash');
  if (flash) {
    flash.classList.add('show');
    setTimeout(() => flash.classList.remove('show'), 220);
  }
  // vibration if available
  if (navigator.vibrate) {
    try { navigator.vibrate(60); } catch(e) {}
  }
}

async function loadData() {
  try {
    const res = await fetch('magics.json');
    gameData = await res.json();
  } catch (e) {
    console.error('magics.json load error', e);
    // still continue; user will see camera but no data
    gameData = { magics: [], media_data: {} };
  }

  try {
    cameras = await Html5Qrcode.getCameras();
  } catch (e) {
    console.warn('getCameras failed', e);
    cameras = [];
  }

  const back = cameras.findIndex(c => /back|rear|environment/i.test(c.label));
  cameraIndex = back >= 0 ? back : 0;

  // start with barcode mode by default
  startScanner('barcode');
}

async function startScanner(mode) {
  currentMode = mode;
  lastResult = null;
  scanArmed = false;
  // clear transient messages
  const tEl = document.getElementById('transient-msg');
  tEl.style.display = 'none';
  clearTimeout(transientTimer);

  const statusEl = document.getElementById('status-msg');
  statusEl.classList.remove('ready');
  statusEl.innerText = mode === 'qr' ? "QR„Ç≥„Éº„Éâ„ÇíÊé¢Á¥¢‰∏≠..." : "„Éê„Éº„Ç≥„Éº„Éâ„ÇíÊé¢Á¥¢‰∏≠...";

  if (html5QrCode) await html5QrCode.stop().catch(()=>{});

  document.getElementById('btn-barcode').classList.toggle('active', mode === 'barcode');
  document.getElementById('btn-qr').classList.toggle('active', mode === 'qr');

  document.getElementById('qr-shutter').style.display = mode === 'qr' ? 'block' : 'none';
  document.getElementById('barcode-line').style.display = mode === 'barcode' ? 'block' : 'none';

  html5QrCode = new Html5Qrcode("reader");

  const formats = mode === 'qr'
    ? [ Html5QrcodeSupportedFormats.QR_CODE ]
    : [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E
      ];

  try {
    await html5QrCode.start(
      (cameras && cameras[cameraIndex]) ? cameras[cameraIndex].id : { facingMode: "environment" },
      { fps: 10, formatsToSupport: formats },
      (text) => {
        // note: we intentionally arm on first valid read (scanArmed false -> true)
        // but do NOT auto-confirm; user must press the scan button.
        if (!scanArmed) {
          lastResult = text;
          scanArmed = true;
          const statusEl2 = document.getElementById('status-msg');
          statusEl2.classList.add('ready');
          statusEl2.innerText = "Ëß£ÊûêÁ¢∫ÂÆöÂèØËÉΩ";
        } else {
          // update lastResult quietly for potential re-confirm
          lastResult = text;
        }
      },
      (error) => {
        // per-frame errors are ignored; keep console for debugging
        // console.debug('frame error', error);
      }
    );
  } catch (err) {
    console.error('start failed', err);
    document.getElementById('status-msg').innerText = "„Ç´„É°„É©„ÇíËµ∑Âãï„Åß„Åç„Åæ„Åõ„Çì";
  }
}

function switchCamera() {
  if (!cameras || cameras.length === 0) {
    // nothing to switch
    showTransient("„Ç´„É°„É©„ÅåË§áÊï∞Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì", 2000);
    return;
  }
  cameraIndex = (cameraIndex + 1) % cameras.length;
  startScanner(currentMode);
}

function pressScan() {
  // note: do not auto-confirm; require scanArmed true
  if (!scanArmed || !lastResult) {
    const s = document.getElementById('status-msg');
    s.classList.remove('ready');
    s.innerText = "ÂØæË±°„ÇíÂêà„Çè„Åõ„Å¶„Åè„Å†„Åï„ÅÑ";
    showTransient("Ë™≠„ÅøÂèñ„Çä„ÅåÁ¢∫Ë™ç„Åß„Åç„Åæ„Åõ„Çì„ÄÇÁîªÈù¢ÂÜÖ„Å´ÂØæË±°„ÇíÂêà„Çè„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", 2500);
    return;
  }

  // Visual + vib feedback pre-confirm (short)
  playSuccessEffect();

  // Now handle the success based on mode & text
  handleSuccess(currentMode, lastResult);
}

function handleSuccess(mode, text) {
  const clean = (text || '').replace(/\*/g, "");
  // If QR mode and MEDIA:... is present, handle as media connect (original behaviour)
  if (mode === 'qr') {
    if (clean.startsWith("MEDIA:")) {
      const id = clean.split(":")[1] || "";
      if (id) {
        // store and redirect like original code
        try { localStorage.setItem('currentMedia', id); } catch(e){}
        // show small confirmation then redirect
        document.getElementById('status-msg').innerText = "Â™í‰Ωì„ÇíÊé•Á∂ö„Åó„Åæ„Åó„Åü...";
        setTimeout(()=> { location.href = "index.html"; }, 600);
        return;
      }
    }
    // otherwise, for QR mode that is not MEDIA:..., treat as not found
    showTransient("Â™í‰Ωì„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü", 3000);
    // reset arm so user can re-scan
    scanArmed = false;
    lastResult = null;
    document.getElementById('status-msg').classList.remove('ready');
    document.getElementById('status-msg').innerText = "QR„Ç≥„Éº„Éâ„ÇíÊé¢Á¥¢‰∏≠...";
    return;
  }

  // barcode mode
  if (mode === 'barcode') {
    // look up in gameData.magics (original behavior)
    const magic = (gameData && gameData.magics) ? gameData.magics.find(m => m.code === clean) : null;
    if (magic) {
      // success: show modal like original
      showModal("DATA ACQUIRED", magic.name, magic.desc);
      // optionally persist acquisition (original code did that on success)
      try {
        let myMagics = JSON.parse(localStorage.getItem('myMagics')) || [];
        if (!myMagics.includes(magic.id)) {
          myMagics.push(magic.id);
          localStorage.setItem('myMagics', JSON.stringify(myMagics));
        }
      } catch (e) {}
      return;
    } else {
      // not found: show message that persists for a few seconds (3s)
      showTransient("È≠îÊ≥ï„Ç≥„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü", 3000);
      // clear ready state so user must re-scan
      scanArmed = false;
      lastResult = null;
      const statusEl = document.getElementById('status-msg');
      statusEl.classList.remove('ready');
      statusEl.innerText = "„Éê„Éº„Ç≥„Éº„Éâ„ÇíÊé¢Á¥¢‰∏≠...";
      return;
    }
  }

  // fallback
  showTransient("Êú™ÂØæÂøú„ÅÆË™≠„ÅøÂèñ„Çä„Åß„Åô", 2500);
}

// modal show/hide (also control HUD visibility via body.modal-open)
function showModal(title, name, desc) {
  document.getElementById('modal-title').innerText = title;
  document.getElementById('modal-name').innerText = name;
  document.getElementById('modal-desc').innerText = desc;
  document.getElementById('result-modal').style.display = 'flex';
  document.body.classList.add('modal-open');
}

function closeModal() {
  document.body.classList.remove('modal-open');
  // original behavior: redirect to index
  location.href = "index.html";
}

// initial load
window.onload = loadData;
</script>
</body>
</html>
