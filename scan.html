<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>é­”æ³•ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
  --accent-red: #ff2d55;
  --accent-grad-start: #ff2d55;
  --accent-grad-end: #ff6a88;
  --ready-green: #00ffcc;
  --bg-dark: #0d0d1a;
  --panel-dark: #0f1120;
  --glow-red: 0 0 18px rgba(255,45,85,0.5);
  --glow-green: 0 0 18px rgba(0,255,204,0.45);
  --controls-h: 180px;
}

/* reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:#000;
  color:#e6e9ff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  min-height:100svh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
}

/* ===== camera area ===== */
#reader-wrapper{
  position:relative;
  width:100%;
  height: calc(100dvh - var(--controls-h));
  max-height: calc(100dvh - var(--controls-h));
  overflow:hidden;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* html5-qrcode container */
#reader{ width:100%!important; height:100%!important; max-width:900px; }

/* ensure video covers whole container */
#reader video { width:100%!important; height:100%!important; object-fit:cover!important; display:block; }

/* flash layer */
#flash-layer { position:absolute; inset:0; pointer-events:none; z-index:150; }

/* HUD corners (red frame) */
/* normally visible during scanning; hidden automatically when modal opens */
.hud-corner {
  position:absolute;
  width:30px; height:30px;
  border:2px solid var(--accent-red);
  filter:drop-shadow(var(--glow-red));
  z-index:140;
  transition:opacity .18s ease, transform .18s ease;
  opacity:1;
}
body.modal-open .hud-corner { opacity:0; transform: scale(.98); }

.top-left{ top:16px; left:16px; border-right:none; border-bottom:none; }
.top-right{ top:16px; right:16px; border-left:none; border-bottom:none; }
.bottom-left{ bottom:16px; left:16px; border-right:none; border-top:none; }
.bottom-right{ bottom:16px; right:16px; border-left:none; border-top:none; }

/* QR shutter & barcode line (JS toggles display) */
#qr-shutter{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  width:220px; height:220px; border-radius:12px;
  border:1px solid rgba(255,45,85,0.35);
  background:linear-gradient(180deg, rgba(255,45,85,0.03), rgba(255,45,85,0.02));
  box-shadow: inset 0 0 20px rgba(255,45,85,0.08);
  z-index:130; display:none;
}
#barcode-line{
  position:absolute; left:10%; top:50%; width:80%; height:2px;
  background:var(--accent-red); box-shadow:var(--glow-red);
  z-index:130; display:none;
  animation: scan-move 2s infinite ease-in-out;
}
@keyframes scan-move { 0%,100%{ transform: translateY(-40px); opacity:.25 } 50%{ transform: translateY(40px); opacity:1 } }

/* ===== controls (bottom) ===== */
.controls{
  width:100%;
  background:var(--panel-dark);
  border-top:1px solid rgba(255,45,85,0.06);
  padding:18px 16px calc(22px + env(safe-area-inset-bottom));
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  box-shadow: 0 -10px 30px rgba(0,0,0,0.6);
}

/* status text */
#status-msg{
  font-size:0.85rem;
  color:#9aa3b2;
  letter-spacing:.08em;
  transition: color .18s ease, text-shadow .18s ease;
  text-align:center;
  min-height:1.1em;
}
#status-msg.ready {
  color: var(--ready-green);
  text-shadow: var(--glow-green);
}

/* main scan confirm button */
#scan-trigger{
  width:100%;
  max-width:520px;
  height:56px;
  border-radius:14px;
  border:none;
  background: linear-gradient(135deg,var(--accent-grad-start),var(--accent-grad-end));
  color:#fff;
  font-weight:800;
  font-size:1.05rem;
  box-shadow: var(--glow-red);
  -webkit-tap-highlight-color:transparent;
  cursor:pointer;
}

/* button group: mode + switch */
.btn-group{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
}

.mode-btn{
  min-width:110px;
  height:44px;
  padding:0 16px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.04);
  background: linear-gradient(180deg,#0c0c12,#0a0a12);
  color:#cdd6e6;
  font-weight:700;
  font-size:.95rem;
  box-shadow: 0 3px 8px rgba(0,0,0,0.5);
  cursor:pointer;
}
.mode-btn.active{
  background: linear-gradient(135deg, rgba(255,45,85,0.2), rgba(255,45,85,0.08));
  color:#fff;
  border-color: rgba(255,45,85,0.2);
  box-shadow: var(--glow-red);
}

/* camera switch button uses same style */
.btn-group .mode-btn.switch { min-width:48px; padding:0; width:48px; }

/* cancel */
.back-link{ color:#9aa3b2; font-size:.86rem; text-decoration:none; opacity:.95 }

/* ===== result modal (redesigned) ===== */
#result-modal{
  display:none;
  position:fixed;
  inset:0;
  background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85));
  z-index:999;
  justify-content:center;
  align-items:center;
  padding:22px;
}
.modal-card{
  width:100%;
  max-width:520px;
  background: linear-gradient(180deg,#0f1030,#0b0b18);
  border-radius:20px;
  border: 1px solid rgba(255,45,85,0.12);
  padding:22px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.7), var(--glow-red);
  color:#e9ecff;
  text-align:center;
}

/* small label */
.modal-label {
  font-size:0.75rem;
  color:#9aa3b2;
  margin-bottom:8px;
  letter-spacing:.12em;
}

/* big name */
.modal-name {
  font-size: clamp(1.4rem, 4.8vw, 2.4rem);
  color: var(--accent-red);
  font-weight:900;
  text-shadow: 0 0 10px rgba(255,45,85,0.18);
  margin:6px 0 10px;
}

/* description */
.modal-desc {
  font-size:1rem;
  color:#cfe7ff;
  line-height:1.45;
  margin-bottom:18px;
  min-height:3.2em;
}

/* big action button */
.modal-cta{
  width:100%;
  height:56px;
  border-radius:12px;
  border:none;
  font-weight:800;
  font-size:1rem;
  color:#061018;
  background: linear-gradient(135deg,#00ffd0,#00c2a8);
  box-shadow: var(--glow-green);
  cursor:pointer;
  margin-top:6px;
}

/* secondary small close */
.modal-cancel{
  margin-top:12px;
  display:inline-block;
  color:#b8c8da;
  text-decoration:underline;
}

/* hide html5 dashboard if present */
#reader__dashboard{ display:none!important; }
</style>
</head>

<body>

<!-- camera area -->
<div id="reader-wrapper">
  <div id="flash-layer"></div>

  <div class="hud-corner top-left"></div>
  <div class="hud-corner top-right"></div>
  <div class="hud-corner bottom-left"></div>
  <div class="hud-corner bottom-right"></div>

  <div id="reader"></div>

  <div id="qr-shutter"></div>
  <div id="barcode-line"></div>
</div>

<!-- controls -->
<div class="controls">
  <div id="status-msg">SYSTEM READY</div>

  <button id="scan-trigger" onclick="pressScan()">è§£æã‚’ç¢ºå®šã™ã‚‹</button>

  <div class="btn-group">
    <button id="btn-barcode" class="mode-btn" onclick="startScanner('barcode')">é­”æ³•ç¿’å¾—</button>
    <button id="btn-qr" class="mode-btn" onclick="startScanner('qr')">åª’ä½“æ¥ç¶š</button>
    <button class="mode-btn switch" onclick="switchCamera()">ğŸ“·</button>
  </div>

  <a href="index.html" class="back-link">CANCEL</a>
</div>

<!-- modal -->
<div id="result-modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-label" id="modal-title">DATA ACQUIRED</div>
    <div id="modal-name" class="modal-name">é­”æ³•å</div>
    <div id="modal-desc" class="modal-desc">èª¬æ˜æ–‡</div>

    <button class="modal-cta" id="modal-ok" onclick="closeModal()">é–‰ã˜ã‚‹ã—ã¦å…ƒã«æˆ»ã‚‹</button>
    <div><a href="#" class="modal-cancel" onclick="closeModal(); return false;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a></div>
  </div>
</div>

<script>
/* ã‚«ãƒ¡ãƒ© / è§£æãƒ­ã‚¸ãƒƒã‚¯ã¯æ©Ÿèƒ½ã‚’å¤‰ãˆãšç¶­æŒã—ã¦ã„ã¾ã™ï¼ˆå¿…è¦æœ€å°ã® UI ãƒ•ãƒ©ã‚°è¿½åŠ ã®ã¿ï¼‰ */
let html5QrCode;
let cameras = [];
let cameraIndex = 0;
let lastResult = null;
let scanArmed = false;
let currentMode = 'barcode';
let gameData = null;

async function loadData() {
  const res = await fetch('magics.json');
  gameData = await res.json();
  cameras = await Html5Qrcode.getCameras();

  const back = cameras.findIndex(c => /back|rear|environment/i.test(c.label));
  cameraIndex = back >= 0 ? back : 0;

  startScanner('barcode');
}

async function startScanner(mode) {
  currentMode = mode;
  lastResult = null;
  scanArmed = false;

  // çŠ¶æ…‹è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
  const statusEl = document.getElementById('status-msg');
  statusEl.classList.remove('ready');
  statusEl.innerText = "ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­";

  if (html5QrCode) await html5QrCode.stop().catch(()=>{});

  document.getElementById('btn-barcode').classList.toggle('active', mode==='barcode');
  document.getElementById('btn-qr').classList.toggle('active', mode==='qr');

  document.getElementById('qr-shutter').style.display = mode==='qr' ? 'block' : 'none';
  document.getElementById('barcode-line').style.display = mode==='barcode' ? 'block' : 'none';

  html5QrCode = new Html5Qrcode("reader");

  const formats = mode==='qr'
    ? [Html5QrcodeSupportedFormats.QR_CODE]
    : [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E
      ];

  html5QrCode.start(
    cameras[cameraIndex].id,
    { fps:10, formatsToSupport:formats },
    (text) => {
      // æœ€åˆã®ã€Œã¾ã¨ã‚‚ãªã€èª­ã¿å–ã‚Šã‚’æ¤œå‡ºã—ãŸã‚‰ scanArmed ã‚’ true ã«ã™ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºå®šæŠ¼ã›ã°æˆåŠŸï¼‰
      if (!scanArmed) {
        lastResult = text;
        scanArmed = true;
        statusEl.classList.add('ready');
        statusEl.innerText = "è§£æç¢ºå®šå¯èƒ½";
      } else {
        // ä»¥é™ã¯ lastResult ã‚’æ›´æ–°ã—ã¦ã‚‚ UI ã¯å¤‰ãˆãªã„ï¼ˆé€£ç¶šèª­ã¿å–ã‚Šã‚’é˜²ãï¼‰
        lastResult = text;
      }
    },
    (err) => {
      // ãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ã® read ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ã« console ã«å‡ºã™ï¼‰
      // console.debug('scan err', err);
    }
  ).catch(err => {
    document.getElementById('status-msg').innerText = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“";
    console.error(err);
  });
}

function switchCamera() {
  if (!cameras || cameras.length === 0) return;
  cameraIndex = (cameraIndex + 1) % cameras.length;
  startScanner(currentMode);
}

function pressScan() {
  if (!scanArmed || !lastResult) {
    // åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    const el = document.getElementById('status-msg');
    el.classList.remove('ready');
    el.innerText = "å¯¾è±¡ã‚’åˆã‚ã›ã¦ãã ã•ã„";
    return;
  }
  handleSuccess(currentMode, lastResult);
}

function handleSuccess(mode, text) {
  const clean = text.replace(/\*/g,'');
  if (mode === 'barcode') {
    const magic = gameData.magics.find(m => m.code === clean);
    if (magic) showModal("DATA ACQUIRED", magic.name, magic.desc);
    else {
      // èª­ã¿å–ã‚Šã¯ã§ããŸãŒç™»éŒ²ç„¡ã—
      const el = document.getElementById('status-msg');
      el.classList.remove('ready');
      el.innerText = "è©²å½“ã™ã‚‹é­”æ³•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
      scanArmed = false;
      lastResult = null;
    }
  } else {
    // QR ãªã©ã®å‡¦ç†ãŒã‚ã‚Œã°ã“ã“ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ã®æŒ™å‹•ã«åˆã‚ã›ã‚‹ï¼‰
    // ä»Šã¯åŸºæœ¬çš„ã« barcode ã®ã¿ã®æ‰±ã„ã¨ã—ã¦ãŠã
  }
}

/* showModal / closeModal ã¯ UI ã®çŠ¶æ…‹ã‚‚æ‰±ã†ï¼ˆHUD ã‚’æ¶ˆã™ãŸã‚ body.modal-open ã‚’ä»˜ã‘å¤–ã—ï¼‰ */
function showModal(title, name, desc) {
  document.getElementById('modal-title').innerText = title;
  document.getElementById('modal-name').innerText = name;
  document.getElementById('modal-desc').innerText = desc;
  document.getElementById('result-modal').style.display = 'flex';
  document.body.classList.add('modal-open');
}

function closeModal() {
  document.body.classList.remove('modal-open');
  // å…ƒã‚³ãƒ¼ãƒ‰ã®æŒ™å‹•ã‚’ç¶­æŒï¼šæˆ»ã‚‹
  location.href = "index.html";
}

window.onload = loadData;
</script>
</body>
</html>
