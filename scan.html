<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>é­”æ³•ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
  --accent-red:#ff2d55;
  --bg-dark:#0d0d1a;
  --panel-dark:#0f1020;
  --glow:0 0 14px rgba(255,45,85,.6);
  --controls-h: 176px; /* æ“ä½œãƒ‘ãƒãƒ«ã®æƒ³å®šé«˜ã•ï¼ˆsafe-area ã‚’å«ã‚ã‚‹ï¼‰ */
}

/* åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}

/* ç”»é¢å…¨ä½“ã‚’ä½¿ã†ï¼ˆiOS/AndroidæŒ™å‹•ã«å¼·ã„ï¼‰ */
body{
  background:#000;
  color:#e0e0ff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  min-height:100svh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* ==== ã‚«ãƒ¡ãƒ©é ˜åŸŸ (ä¸Šéƒ¨) ==== */
/* æ˜ç¢ºã«ã€Œç”»é¢ã®ä¸Š: calc(100dvh - controls)ã€ã«ã—ã¦é»’å¸¯ã‚’é˜²æ­¢ */
#reader-wrapper{
  position:relative;
  width:100%;
  height: calc(100dvh - var(--controls-h));
  max-height: calc(100dvh - var(--controls-h));
  overflow:hidden;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
}

/* #reader ã¯ html5-qrcode ãŒä½¿ã†ã‚³ãƒ³ãƒ†ãƒŠã€‚flex ã§ã¯ãªã block ã«ã—ã¦å®‰å®šã•ã›ã‚‹ */
#reader{
  width:100%!important;
  height:100%!important;
  max-width:600px; /* è¦‹ãŸç›®åˆ¶é™ï¼šå¤§ãã„ç”»é¢ã§ã¯ reader ã‚’ä¸­å¤®ã«ä¿ã¤ */
}

/* video è¦ç´ ã®æŒ¯ã‚‹èˆã„ã‚’æ˜ç¢ºã« */
#reader video{
  width:100%!important;
  height:100%!important;
  object-fit:cover!important;
  display:block;
}

/* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
#flash-layer{position:absolute;inset:0;pointer-events:none;z-index:150}

/* HUD ã¯åˆæœŸéè¡¨ç¤ºã«ã—ã¦ãŠãï¼ˆèª­ã¿è¾¼ã¿UIã§æ®‹ã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
/* å¿…è¦ãªã‚‰ JS ã§ reader-wrapper ã« .scanning ã‚’ä»˜ã‘ã¦è¡¨ç¤ºã§ãã‚‹ */
.hud-corner{
  position:absolute;
  width:30px;height:30px;
  border:2px solid var(--accent-red);
  filter:drop-shadow(var(--glow));
  z-index:140;
  opacity:0; /* åˆæœŸã¯è¦‹ãˆãªã„ */
  transition:opacity .25s ease;
}
#reader-wrapper.scanning .hud-corner{ opacity:1; } /* JS ã§åˆ¶å¾¡å¯èƒ½ */
.top-left{ top:18px; left:18px; border-right:none;border-bottom:none; }
.top-right{ top:18px; right:18px; border-left:none;border-bottom:none; }
.bottom-left{ bottom:18px; left:18px; border-right:none;border-top:none; }
.bottom-right{ bottom:18px; right:18px; border-left:none;border-top:none; }

/* QR ã‚·ãƒ¥ã‚¿ãƒ¼ / ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ³ã¯èª­ã¿å–ã‚Šãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤ºï¼ˆJS ãŒ display å¤‰æ›´ã—ã¦ã„ã‚‹ã®ã§ OKï¼‰ */
#qr-shutter{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  width:220px; height:220px; border:1px solid rgba(255,45,85,.5);
  background:rgba(255,45,85,.04); box-shadow:inset 0 0 18px rgba(255,45,85,.12);
  z-index:130; display:none;
}
#barcode-line{
  position:absolute; left:10%; top:50%; width:80%; height:2px;
  background:var(--accent-red); box-shadow:var(--glow);
  z-index:130; display:none;
}

/* ==== æ“ä½œãƒ‘ãƒãƒ« (ä¸‹éƒ¨) ==== */
/* ã“ã“ã§ safe-area ã‚’è€ƒæ…®ã—ã¦ååˆ†ãªä¸‹ä½™ç™½ã‚’ç¢ºä¿ */
.controls{
  width:100%;
  background:var(--panel-dark);
  border-top:1px solid rgba(255,45,85,0.08);
  padding:18px 16px calc(18px + env(safe-area-inset-bottom));
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  box-shadow: 0 -6px 20px rgba(0,0,0,0.6);
  /* é«˜ã•ã‚’å›ºå®šçš„ã«æ‰±ã‚ãš padding ã§å®‰å…¨ã«ä½™ç™½ç¢ºä¿ */
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å°ã•ãè½ã¡ç€ã„ãŸè‰²ã§ */
#status-msg{
  font-size:.75rem;
  color:#9aa;
  letter-spacing:.08em;
}

/* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼ˆä»Šé¢¨ã§æŠ¼ã—ã‚„ã™ã„ï¼‰ */
#scan-trigger{
  width:100%;
  max-width:480px;
  height:54px;
  border-radius:14px;
  border:none;
  background:linear-gradient(135deg,var(--accent-red),#ff6a88);
  color:#fff;
  font-weight:700;
  font-size:1rem;
  box-shadow:var(--glow);
  -webkit-tap-highlight-color: transparent;
}

/* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
.btn-group{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}

/* ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã¯ãƒ•ãƒ©ãƒƒãƒˆã§è¦–èªæ€§è‰¯ã */
.mode-btn{
  min-width:100px;
  height:42px;
  padding:0 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.06);
  background:linear-gradient(180deg,#12121a,#0b0b10);
  color:#d0d6e0;
  font-weight:600;
  font-size:.88rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.6);
}
.mode-btn.active{
  background:linear-gradient(135deg, rgba(255,45,85,.18), rgba(255,45,85,.08));
  color:#fff;
  border-color: rgba(255,45,85,0.25);
  box-shadow: var(--glow);
}

/* CANCEL (è»½ã‚) */
.back-link{
  color:#99a;
  text-decoration:none;
  font-size:.82rem;
  margin-top:2px;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãã®ã¾ã¾ï¼‰ */
#result-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.9); display:flex; justify-content:center; align-items:center; z-index:999; }
.modal-content{ background:#101025; border-radius:16px; padding:20px; width:86%; max-width:340px; border:1px solid rgba(255,45,85,0.12); box-shadow:var(--glow); color:#e6e9ff; text-align:center; }
.modal-content button{ margin-top:12px; padding:10px 14px; border-radius:12px; border:none; background:var(--accent-red); color:#fff; font-weight:700; }

/* éè¡¨ç¤ºãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
#reader__dashboard{ display:none!important; }
</style>
</head>

<body>

<div id="reader-wrapper">
    <div id="flash-layer"></div>

    <!-- HUD ã¯åˆæœŸéè¡¨ç¤ºã€‚JSã§ .scanning ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ã‚‹ã¨è¡¨ç¤ºã§ãã¾ã™ -->
    <div class="hud-corner top-left"></div>
    <div class="hud-corner top-right"></div>
    <div class="hud-corner bottom-left"></div>
    <div class="hud-corner bottom-right"></div>

    <!-- html5-qrcode ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆJSã¯å¤‰æ›´ç„¡ã—ï¼‰ -->
    <div id="reader"></div>

    <!-- è¡¨ç¤ºã¯ startScanner() ãŒåˆ‡ã‚Šæ›¿ãˆã¾ã™ï¼ˆJSãã®ã¾ã¾ï¼‰ -->
    <div id="qr-shutter"></div>
    <div id="barcode-line"></div>
</div>

<div class="controls">
    <div id="status-msg">SYSTEM READY</div>

    <button id="scan-trigger" onclick="pressScan()">è§£æã‚’ç¢ºå®šã™ã‚‹</button>

    <div class="btn-group">
        <button id="btn-barcode" class="mode-btn" onclick="startScanner('barcode')">é­”æ³•ç¿’å¾—</button>
        <button id="btn-qr" class="mode-btn" onclick="startScanner('qr')">åª’ä½“æ¥ç¶š</button>
        <button class="mode-btn" onclick="switchCamera()">ğŸ“·åˆ‡æ›¿</button>
    </div>

    <a href="index.html" class="back-link">CANCEL</a>
</div>

<div id="result-modal">
    <div class="modal-content">
        <div id="modal-title">DATA ACQUIRED</div>
        <div id="modal-name" class="modal-name">é­”æ³•å</div>
        <div id="modal-desc"></div>
        <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<!-- === JS ã¯ã‚ãªãŸãŒè²¼ã£ã¦ãã‚ŒãŸã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ã„ã¾ã™ï¼ˆå¤‰æ›´ç„¡ã—ï¼‰ === -->
<script>
let html5QrCode;
let cameras = [];
let cameraIndex = 0;
let lastResult = null;
let currentMode = 'barcode';
let gameData = null;

async function loadData() {
    const res = await fetch('magics.json');
    gameData = await res.json();
    cameras = await Html5Qrcode.getCameras();

    const back = cameras.findIndex(c => /back|rear|environment/i.test(c.label));
    cameraIndex = back >= 0 ? back : 0;

    startScanner('barcode');
}

async function startScanner(mode) {
    currentMode = mode;
    lastResult = null;

    if (html5QrCode) await html5QrCode.stop().catch(()=>{});

    document.getElementById('btn-barcode').classList.toggle('active', mode==='barcode');
    document.getElementById('btn-qr').classList.toggle('active', mode==='qr');

    document.getElementById('qr-shutter').style.display = mode==='qr'?'block':'none';
    document.getElementById('barcode-line').style.display = mode==='barcode'?'block':'none';

    html5QrCode = new Html5Qrcode("reader");

    const formats = mode==='qr'
        ? [Html5QrcodeSupportedFormats.QR_CODE]
        : [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E
        ];

    html5QrCode.start(
        cameras[cameraIndex].id,
        { fps:10, formatsToSupport:formats },
        text => {
            if (text !== lastResult) {
                lastResult = text;
                document.getElementById('status-msg').innerText = "è§£ææº–å‚™å®Œäº†";
            }
        }
    );
}

function switchCamera() {
    cameraIndex = (cameraIndex + 1) % cameras.length;
    startScanner(currentMode);
}

function pressScan() {
    if (!lastResult) return;
    handleSuccess(currentMode, lastResult);
}

function handleSuccess(mode, text) {
    const clean = text.replace(/\*/g,'');
    if (mode==='barcode') {
        const magic = gameData.magics.find(m=>m.code===clean);
        if (magic) showModal("NEW SKILL", magic.name, magic.desc);
    }
}

function showModal(t,n,d){
    document.getElementById('modal-title').innerText=t;
    document.getElementById('modal-name').innerText=n;
    document.getElementById('modal-desc').innerText=d;
    document.getElementById('result-modal').style.display='flex';
}

function closeModal(){ location.href="index.html"; }

window.onload = loadData;
</script>

</body>
</html>
