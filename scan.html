<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>魔法スキャナー</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
  --red:#ff2d55;
  --green:#00ffcc;
  --dark:#0b0c18;
}
html,body{
  margin:0;
  height:100%;
  background:#000;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}
body{overflow:hidden}

/* ===== Camera ===== */
#camera-wrap{
  position:relative;
  width:100%;
  height:calc(100dvh - 180px);
  overflow:hidden;
}
#reader, #reader video{
  width:100%!important;
  height:100%!important;
  object-fit:cover!important;
}

/* ===== HUD ===== */
.hud{
  position:absolute;
  width:28px;height:28px;
  border:2px solid var(--red);
  z-index:5;
}
.tl{top:14px;left:14px;border-right:none;border-bottom:none}
.tr{top:14px;right:14px;border-left:none;border-bottom:none}
.bl{bottom:14px;left:14px;border-right:none;border-top:none}
.br{bottom:14px;right:14px;border-left:none;border-top:none}

/* ===== Flash ===== */
.flash{
  position:absolute;
  inset:0;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s;
  z-index:10;
}
.flash.green{background:rgba(0,255,204,.18)}
.flash.red{background:rgba(255,45,85,.18)}
.flash.show{opacity:1}

/* ===== Overlay Message ===== */
#overlay{
  position:absolute;
  top:10%;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.8);
  border-radius:14px;
  padding:12px 18px;
  font-weight:700;
  opacity:0;
  transition:.25s;
  z-index:20;
}
#overlay.show{opacity:1}
#overlay.error{border:1px solid var(--red);color:#ffd6dd}
#overlay.success{border:1px solid var(--green);color:#002d26;background:rgba(0,255,204,.15)}

/* ===== Controls ===== */
#controls{
  height:180px;
  background:var(--dark);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px;
  gap:10px;
}
#status{
  font-size:.85rem;
  color:#aaa;
}
#status.ready{
  color:var(--green);
}
button{
  border:none;
  border-radius:14px;
  height:52px;
  width:100%;
  max-width:420px;
  font-weight:800;
}
#scan-btn{
  background:linear-gradient(135deg,var(--red),#ff6a88);
  color:#fff;
}
.mode-row{display:flex;gap:10px}
.mode{
  height:44px;
  padding:0 16px;
  background:#111;
  color:#ccc;
}
.mode.active{
  background:rgba(255,45,85,.25);
  color:#fff;
}
a{color:#aaa;font-size:.8rem}

/* ===== Modal ===== */
#modal{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,.7);
  z-index:100;
}
.card{
  background:#0f1030;
  padding:24px;
  border-radius:22px;
  max-width:520px;
  width:90%;
  text-align:center;
}
.card h1{margin:.2em 0;color:var(--red)}
.card p{color:#cfe7ff}
.card .ok{
  background:linear-gradient(135deg,var(--green),#00c2a8);
  color:#001f18;
  margin-top:14px;
}
.card .cancel{
  display:block;
  margin-top:12px;
  text-decoration:underline;
  color:#ffd6dd;
}
</style>
</head>

<body>

<div id="camera-wrap">
  <div id="reader"></div>

  <div class="hud tl"></div><div class="hud tr"></div>
  <div class="hud bl"></div><div class="hud br"></div>

  <div id="flash-green" class="flash green"></div>
  <div id="flash-red" class="flash red"></div>

  <div id="overlay"></div>
</div>

<div id="controls">
  <div id="status">SYSTEM READY</div>
  <button id="scan-btn" onclick="pressScan()">解析を確定する</button>

  <div class="mode-row">
    <button class="mode active" id="m-bar" onclick="setMode('barcode')">魔法習得</button>
    <button class="mode" id="m-qr" onclick="setMode('qr')">媒体接続</button>
  </div>

  <a href="index.html">CANCEL</a>
</div>

<div id="modal">
  <div class="card">
    <small>DATA ACQUIRED</small>
    <h1 id="m-name">魔法名</h1>
    <p id="m-desc"></p>
    <button class="ok" onclick="confirm()">閉じるして元に戻る</button>
    <a class="cancel" onclick="cancel()">キャンセル</a>
  </div>
</div>

<script>
let qr, cameras=[], camIndex=0;
let mode='barcode';
let armed=false;
let last=null;
let data=null;

/* ===== Effects ===== */
function flash(type){
  const el=document.getElementById(type==='green'?'flash-green':'flash-red');
  el.classList.add('show');
  navigator.vibrate?.(type==='green'?60:[30,20,30]);
  setTimeout(()=>el.classList.remove('show'),300);
}
function overlay(msg,type='error',t=2500){
  const o=document.getElementById('overlay');
  o.textContent=msg;
  o.className='show '+type;
  setTimeout(()=>o.className='',t);
}

/* ===== Load ===== */
fetch('magics.json').then(r=>r.json()).then(j=>data=j);
Html5Qrcode.getCameras().then(c=>{
  cameras=c;
  start();
});

function start(){
  qr=new Html5Qrcode('reader');
  qr.start(
    cameras[camIndex]?.id||{facingMode:'environment'},
    {fps:10},
    txt=>{
      last=txt.replace(/\*/g,'');
      armed=true;
      const s=document.getElementById('status');
      s.textContent='解析確定可能';
      s.classList.add('ready');
    }
  );
}

/* ===== UI ===== */
function setMode(m){
  mode=m;
  armed=false;last=null;
  document.getElementById('status').textContent=
    m==='qr'?'QRコードを探索中':'バーコードを探索中';
  document.getElementById('status').classList.remove('ready');
  document.getElementById('m-bar').classList.toggle('active',m==='barcode');
  document.getElementById('m-qr').classList.toggle('active',m==='qr');
}

/* ===== Scan Button ===== */
function pressScan(){
  if(!armed){
    flash('red');
    overlay('読み取り対象が見つかりません');
    return;
  }

  if(mode==='qr'){
    if(last.startsWith('MEDIA:')){
      flash('green');
      setTimeout(()=>{
        localStorage.setItem('currentMedia',last.split(':')[1]);
        qr.stop().then(()=>location.href='index.html');
      },450);
    }else{
      flash('red');
      overlay('媒体データが見つかりません');
    }
    return;
  }

  const m=data.magics.find(x=>x.code===last);
  if(!m){
    flash('red');
    overlay('魔法コードが見つかりませんでした');
    return;
  }

  flash('green');
  setTimeout(()=>{
    document.getElementById('m-name').textContent=m.name;
    document.getElementById('m-desc').textContent=m.desc;
    document.getElementById('modal').style.display='flex';
  },450);
}

/* ===== Modal ===== */
function cancel(){
  flash('red');
  overlay('取得をキャンセルしました');
  document.getElementById('modal').style.display='none';
}
function confirm(){
  qr.stop().then(()=>location.href='index.html');
}
</script>

</body>
</html>
